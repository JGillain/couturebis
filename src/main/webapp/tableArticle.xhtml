<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:c="http://java.sun.com/jsp/jstl/core"
      xmlns:shiro="http://shiro.apache.org/tags"
      xmlns:p="http://primefaces.org/ui">

<ui:composition template="Template/template.xhtml">

    <ui:define name="title">#{I18N['application.article.title']}</ui:define>
    <ui:define name="content">

        <h:form prependId="false">
            <p:panel layout="block" id="content">
                <p:growl id="growl" showDetail="true" sticky="true" />
                <h2 style="text-align:center">#{I18N['application.article.title']}</h2>

                <p:dataTable value="#{articleBean.listart}"
                             var="art"
                             id="tableArticle"
                             widgetVar="arTbl"
                             class="table hide-filters"
                             headerClass="table-header"
                             rowClasses="table-odd-row,table-even-row"
                             rowStyleClass="#{art.actif ? '' : 'highlight-row'}"
                             paginator="true"
                             rows="10"
                             paginatorTemplate="{CurrentPageReport}  {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink}"
                             currentPageReportTemplate="Page {currentPage} sur {totalPages}">

                    <!-- Nom (filter) -->
                    <p:column filterBy="#{art.nom}" filterMatchMode="contains">
                        <f:facet name="header">#{I18N['Articles.label.denomination']}</f:facet>
                        <p:outputLabel value ="#{art.nom}"/>
                    </p:column>

                    <!-- Numéro de série (filter) -->
                    <p:column filterBy="#{art.numSerie}" filterMatchMode="contains">
                        <f:facet name="header">#{I18N['Articles.label.numSerie']}</f:facet>
                        <p:outputLabel value ="#{art.numSerie} "/>
                    </p:column>

                    <!-- Fabricant (filter) -->
                    <p:column filterBy="#{art.fabricantIdFabricant.nom}" filterMatchMode="contains">
                        <f:facet name="header">#{I18N['Articles.label.Fabricant']}</f:facet>
                        <p:outputLabel value ="#{art.fabricantIdFabricant.nom} "/>
                    </p:column>

                    <p:column>
                        <f:facet name="header">Stock (Loc/Vente)</f:facet>
                        <h:panelGroup layout="block" styleClass="dot-half"
                                      style="background: linear-gradient(to right,
                           #{articleBean.getStockLocation(art) == 0
                               ? 'red'
                               : (articleBean.getStockLocation(art) le art.stockMin
                                   ? 'orange'
                                   : 'green')} 50%,
                           #{articleBean.getStockVente(art) == 0
                               ? 'red'
                               : (articleBean.getStockVente(art) le art.stockMin
                                   ? 'orange'
                                   : 'green')} 50%)" />
                    </p:column>

                    <p:column>
                        <p:commandButton icon="pi pi-plus" value="Details" action="articleDetail">
                            <f:setPropertyActionListener target="#{articleBean.article}" value="#{art}"/>
                        </p:commandButton>
                    </p:column>

                    <p:column>
                        <p:commandButton icon="pi pi-pencil" value="Modifier" action="formEditArticle.xhtml?faces-redirect=true">
                            <f:setPropertyActionListener target="#{articleBean.article}" value="#{art}" />
                        </p:commandButton>
                    </p:column>

                    <!-- Activer / Désactiver + filter toggle/clear in header -->
                    <p:column>
                        <f:facet name="header">
                            <h:panelGroup style="display:flex;gap:.5rem;align-items:center;justify-content:flex-end">
                                <p:commandButton type="button" icon="pi pi-filter"
                                                 title="#{I18N['application.button.filters']}"
                                                 onclick="PF('arTbl').jq.toggleClass('hide-filters');" />
                                <p:commandButton type="button" icon="pi pi-times"
                                                 title="#{I18N['application.button.clear']}"
                                                 onclick="PF('arTbl').clearFilters();" />
                            </h:panelGroup>
                        </f:facet>

                        <p:commandButton rendered="#{art.actif}"
                                         icon="pi pi-power-off"
                                         value ="Désactiver"
                                         action="#{articleBean.activdesactivArt}">
                            <f:setPropertyActionListener target="#{articleBean.article}" value="#{art}" />
                            <p:confirm header="Confirmation"
                                       message="#{I18N['Articles.form.questionconfirm']}"
                                       icon="pi pi-exclamation-triangle"/>
                        </p:commandButton>

                        <p:commandButton rendered="#{!art.actif}" icon="pi pi-check" value ="Activer" action="#{articleBean.activdesactivArt}">
                            <f:setPropertyActionListener target="#{articleBean.article}" value="#{art}" />
                        </p:commandButton>

                    </p:column>

                    <p:column id="actifCol" filterBy="#{art.actif}" filterMatchMode="exact" style="display:none"/>
                    <p:column id="stockCol" filterBy="#{articleBean.stockFlag(art)}" filterMatchMode="exact" style="display:none"/>
                </p:dataTable>
            </p:panel>

            <h:outputScript target="body">
                function toggleStockFilter(val){
                    var input = $(PrimeFaces.escapeClientId('tableArticle:stockCol:filter'));
                    var same  = input.val() === val;

                    input.val(same ? '' : val);
                    PF('arTbl').filter();

                    var redBtn    = $(PrimeFaces.escapeClientId('btnStockRed'));
                    var orangeBtn = $(PrimeFaces.escapeClientId('btnStockOrange'));
                    redBtn.removeClass('ui-state-active');
                    orangeBtn.removeClass('ui-state-active');
                    if(!same){ (val === 'red' ? redBtn : orangeBtn).addClass('ui-state-active'); }
                }

                function clearArticleFilters(){
                    PF('arTbl').clearFilters();
                    $(PrimeFaces.escapeClientId('btnStockRed')).removeClass('ui-state-active');
                    $(PrimeFaces.escapeClientId('btnStockOrange')).removeClass('ui-state-active');
                }
            </h:outputScript>

            <h:panelGroup layout="block" styleClass="button-bar">
                <h:panelGroup styleClass="left-buttons">
                    <p:commandButton icon="pi pi-plus" value="#{I18N['application.button.new']}"
                                     action="formNewArticle.xhtml?faces-redirect=true" />
                </h:panelGroup>

                <h:panelGroup styleClass="center-buttons">
                    <p:commandButton icon="pi pi-search-plus" value="#{I18N['application.button.artActiv']}"
                                     onclick="toggleBoolFilter('arTbl','tableArticle:actifCol:filter','true','btnArtActif',['btnArtInactif'])"/>
                    <p:commandButton icon="pi pi-search-minus" value="#{I18N['application.button.artInactiv']}"
                                     onclick="toggleBoolFilter('arTbl','tableArticle:actifCol:filter','false','btnArtInactif',['btnArtActif'])"/>
                    <p:commandButton id="btnStockRed"
                                     icon="pi pi-exclamation-triangle"
                                     value="#{I18N['application.button.stockCritique']}"
                                     type="button"
                                     onclick="toggleStockFilter('red')" />

                    <p:commandButton id="btnStockOrange"
                                     icon="pi pi-exclamation-circle"
                                     value="#{I18N['application.button.stockBas']}"
                                     type="button"
                                     onclick="toggleStockFilter('orange')" />
                </h:panelGroup>

                <h:panelGroup styleClass="right-buttons">
                    <p:commandButton icon="pi pi-home" value="#{I18N['application.button.returnbienvenue']}"
                                     action="#{articleBean.flushBienv}"/>
                </h:panelGroup>
            </h:panelGroup>

        </h:form>

    </ui:define>
</ui:composition>
</html>
