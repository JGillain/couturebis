<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:f = "http://java.sun.com/jsf/core"
      xmlns:c="http://java.sun.com/jsp/jstl/core"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:shiro="http://shiro.apache.org/tags"
      xmlns:p="http://primefaces.org/ui">
<ui:composition template="Template/template.xhtml">
    <ui:define name="title">#{I18N['tarif.form.nouveau.titre']}</ui:define>

    <ui:define name="content">
        <p:growl id="growl" showDetail="true" sticky="true" />
        <h:form id="newTarif">
            <h:head>
                <title>#{I18N['tarif.form.nouveau.titre']}</title>
            </h:head>
            <h2 style="text-align:center">#{I18N['tarif.form.nouveau.titre']}</h2>

            <p:outputLabel value="#{I18N['magasin.label.Nom']}" />
            <h:panelGroup layout="block" styleClass="button-bar">
                <h:panelGroup styleClass="left-buttons">
                    <p:outputLabel value="#{I18N['tarif.label.dateDebutgrille']}" />
                    <p:calendar value="#{tarifBean.tarif.dateDebut}" showOn="button"
                                required="true" requiredMessage="#{I18N['formulaire.message.required.date']}">
                        <f:convertDateTime timeZone="Europe/Brussels" type="date" pattern="dd/MM/yyyy"/>
                    </p:calendar>
                </h:panelGroup>
                <h:panelGroup styleClass="right-buttons">
                    <p:outputLabel value="#{I18N['tarif.label.nom']}" />
                    <p:inputText id="nomGrille" value="#{tarifBean.tarif.denomination}"
                                 required="true"
                                 requiredMessage="#{I18N['formulaire.message.required.denomination']}"
                                 maxlength="255"/>
                </h:panelGroup>
            </h:panelGroup>

            <!-- ====== TABLE TARIF / JOUR ====== -->
            <p:dataTable id="tarifJour"
                         value="#{tarifBean.grilleJour}"
                         var="J"
                         widgetVar="tjTbl"
                         class="table hide-filters"
                         headerClass="table-header"
                         rowClasses="table-odd-row,table-even-row"
                         editable="true"
                         editMode="row"
                         paginator="true"
                         rows="10"
                         paginatorTemplate="{CurrentPageReport}  {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink}"
                         currentPageReportTemplate="Page {currentPage} sur {totalPages}">

                <!-- Libellé (non-editable, filter) -->
                <p:column headerText="#{I18N['tarif.label.detail']}">
                </p:column>

                <!-- Article (filter on nom) -->
                <p:column headerText="#{I18N['tarifjour.label.article']}"
                          filterBy="#{J.article.nom}"
                          filterMatchMode="contains">
                    <p:cellEditor>
                        <f:facet name="output">
                            <h:outputText value="#{J.article.nom}"/>
                        </f:facet>
                        <f:facet name="input">
                            <p:selectOneMenu id="art"
                                             value="#{J.article}"
                                             converter="articleConverter"
                                             required="true"
                                             requiredMessage="#{I18N['formulaire.message.required.article']}">
                                <f:selectItems value="#{tarifBean.articles}"
                                               var="a"
                                               itemValue="#{a}"
                                               itemLabel="#{a.nom}"/>
                            </p:selectOneMenu>
                            <p:message for="art" display="tooltip"/>
                        </f:facet>
                    </p:cellEditor>
                </p:column>

                <!-- Nombre de jours (filter) -->
                <p:column headerText="#{I18N['tarifjour.label.jour']}"
                          filterBy="#{J.nbrJours}"
                          filterMatchMode="contains">
                    <p:cellEditor>
                        <f:facet name="output">
                            <h:outputText value="#{J.nbrJours}"/>
                        </f:facet>
                        <f:facet name="input">
                            <p:inputText id="jour"
                                         value="#{J.nbrJours}"
                                         maxlength="6"
                                         required="true"
                                         requiredMessage="#{I18N['formulaire.message.required.nbrJ']}"
                                         validatorMessage="Nombre entier requis"
                                         converterMessage="Seuls les chiffres entier positif sont autorisés">
                                <f:validateLongRange minimum="0"/>
                            </p:inputText>
                            <p:message for="jour" display="tooltip"/>
                        </f:facet>
                    </p:cellEditor>
                </p:column>

                <!-- Prix (filter) -->
                <p:column headerText="#{I18N['tarifjour.label.Prix']}"
                          filterBy="#{J.prix}"
                          filterMatchMode="contains">
                    <p:cellEditor>
                        <f:facet name="output">
                            <h:outputText value="#{J.prix}"/>
                        </f:facet>
                        <f:facet name="input">
                            <p:inputText id="prix"
                                         value="#{J.prix}"
                                         maxlength="11"
                                         required="true"
                                         requiredMessage="#{I18N['formulaire.message.required.prix']}">
                                <f:validateDoubleRange minimum="0.0"/>
                            </p:inputText>
                            <p:message for="prix" display="tooltip"/>
                        </f:facet>
                    </p:cellEditor>
                </p:column>

                <!-- Date début (filter on value text) -->
                <p:column headerText="#{I18N['tarifjour.label.DateDebut']}"
                          filterBy="#{J.dateDebut}"
                          filterMatchMode="contains"
                          filterPlaceholder="jj/mm/aaaa">
                    <p:cellEditor>
                        <f:facet name="output">
                            <h:outputText value="#{J.dateDebut}">
                                <f:convertDateTime timeZone="Europe/Brussels" type="date" pattern="dd/MM/yyyy"/>
                            </h:outputText>
                        </f:facet>
                        <f:facet name="input">
                            <p:calendar id="deb"
                                        value="#{J.dateDebut}"
                                        showOn="button"
                                        required="true"
                                        requiredMessage="#{I18N['formulaire.message.required.date']}">
                                <f:convertDateTime timeZone="Europe/Brussels" type="date" pattern="dd/MM/yyyy"/>
                            </p:calendar>
                            <p:message for="deb" display="tooltip"/>
                        </f:facet>
                    </p:cellEditor>
                </p:column>

                <!-- Date fin (filter) -->
                <p:column headerText="#{I18N['tarifjour.label.DateFin']}"
                          filterBy="#{J.dateFin}"
                          filterMatchMode="contains"
                          filterPlaceholder="jj/mm/aaaa">
                    <p:cellEditor>
                        <f:facet name="output">
                            <h:outputText value="#{J.dateFin}">
                                <f:convertDateTime timeZone="Europe/Brussels" type="date" pattern="dd/MM/yyyy"/>
                            </h:outputText>
                        </f:facet>
                        <f:facet name="input">
                            <p:calendar id="fin"
                                        value="#{J.dateFin}"
                                        showOn="button"
                                        required="true"
                                        requiredMessage="#{I18N['formulaire.message.required.date']}">
                                <f:convertDateTime timeZone="Europe/Brussels" type="date" pattern="dd/MM/yyyy"/>
                            </p:calendar>
                            <p:message for="fin" display="tooltip"/>
                        </f:facet>
                    </p:cellEditor>
                </p:column>

                <!-- Tools: show/hide + clear filters -->
                <p:column>
                    <f:facet name="header">
                        <h:panelGroup style="display:flex;gap:.5rem;align-items:center;justify-content:flex-end">
                            <p:commandButton type="button" icon="pi pi-filter"
                                             onclick="PF('tjTbl').jq.toggleClass('hide-filters');" />
                            <p:commandButton type="button" icon="pi pi-times"
                                             onclick="PF('tjTbl').clearFilters();" />
                        </h:panelGroup>
                    </f:facet>
                </p:column>

                <!-- Ajax callbacks -->
                <p:ajax event="rowEdit" listener="#{tarifBean.onJourRowEdit}" update="growl tarifJour"/>
                <p:ajax event="rowEditCancel" listener="#{tarifBean.onJourRowCancel}"/>
            </p:dataTable>

            <h:panelGroup layout="block" styleClass="button-bar">
                <h:panelGroup styleClass="left-buttons">
                    <p:commandButton icon="pi pi-plus" value="#{I18N['tarifjour.label.add']}"
                                     action="#{tarifBean.addNewJourRow}" update="tarifJour" immediate="true"/>
                    <p:commandButton icon="pi pi-minus" value="#{I18N['tarifjour.label.del']}"
                                     action="#{tarifBean.delJourRow}" update="tarifJour" immediate="true"/>
                </h:panelGroup>
            </h:panelGroup>

            <!-- ====== TABLE TARIF / PENALITE ====== -->
            <p:dataTable id="tarifP"
                         value="#{tarifBean.grillePena}"
                         var="P"
                         widgetVar="tpTbl"
                         class="table hide-filters"
                         headerClass="table-header"
                         rowClasses="table-odd-row,table-even-row"
                         editable="true"
                         editMode="row"
                         paginator="true"
                         rows="10"
                         paginatorTemplate="{CurrentPageReport}  {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink}"
                         currentPageReportTemplate="Page {currentPage} sur {totalPages}">

                <p:column headerText="#{I18N['penalite.label.Grille']}">
                </p:column>

                <p:column headerText="#{I18N['tarifpenalite.label.article']}"
                          filterBy="#{P.article.nom}"
                          filterMatchMode="contains">
                    <p:cellEditor>
                        <f:facet name="output">
                            <h:outputText value="#{P.article.nom}"/>
                        </f:facet>
                        <f:facet name="input">
                            <p:selectOneMenu id="part"
                                             value="#{P.article}"
                                             converter="articleConverter"
                                             required="true"
                                             requiredMessage="#{I18N['formulaire.message.required.article']}">
                                <f:selectItems value="#{tarifBean.articles}" var="a" itemValue="#{a}" itemLabel="#{a.nom}"/>
                            </p:selectOneMenu>
                            <p:message for="part" display="tooltip"/>
                        </f:facet>
                    </p:cellEditor>
                </p:column>

                <p:column headerText="#{I18N['tarifpenalite.label.Nom']}"
                          filterBy="#{P.name}"
                          filterMatchMode="contains">
                    <p:cellEditor>
                        <f:facet name="output">
                            <h:outputText value="#{P.name}"/>
                        </f:facet>
                        <f:facet name="input">
                            <p:inputText id="pname"
                                         value="#{P.name}"
                                         maxlength="150"
                                         required="true"
                                         requiredMessage="#{I18N['formulaire.message.required.denomination']}"/>
                            <p:message for="pname" display="tooltip"/>
                        </f:facet>
                    </p:cellEditor>
                </p:column>

                <p:column headerText="#{I18N['tarifpenalite.label.Prix']}"
                          filterBy="#{P.prix}"
                          filterMatchMode="contains">
                    <p:cellEditor>
                        <f:facet name="output">
                            <h:outputText value="#{P.prix}"/>
                        </f:facet>
                        <f:facet name="input">
                            <p:inputText id="pprix"
                                         value="#{P.prix}"
                                         required="true"
                                         requiredMessage="#{I18N['formulaire.message.required.prix']}"
                                         validatorMessage="Nombre positif requis pour le prix pénalité">
                                <f:validateDoubleRange minimum="0.0"/>
                            </p:inputText>
                            <p:message for="pprix" display="tooltip"/>
                        </f:facet>
                    </p:cellEditor>
                </p:column>

                <p:column headerText="#{I18N['tarifpenalite.label.DateDebut']}"
                          filterBy="#{P.dateDebut}"
                          filterMatchMode="contains"
                          filterPlaceholder="jj/mm/aaaa">
                    <p:cellEditor>
                        <f:facet name="output">
                            <h:outputText value="#{P.dateDebut}">
                                <f:convertDateTime timeZone="Europe/Brussels" type="date" pattern="dd/MM/yyyy"/>
                            </h:outputText>
                        </f:facet>
                        <f:facet name="input">
                            <p:calendar id="pdeb"
                                        value="#{P.dateDebut}"
                                        showOn="button"
                                        required="true"
                                        requiredMessage="#{I18N['formulaire.message.required.date']}">
                                <f:convertDateTime timeZone="Europe/Brussels" type="date" pattern="dd/MM/yyyy"/>
                            </p:calendar>
                            <p:message for="pdeb" display="tooltip"/>
                        </f:facet>
                    </p:cellEditor>
                </p:column>

                <p:column headerText="#{I18N['tarifpenalite.label.DateFin']}"
                          filterBy="#{P.dateFin}"
                          filterMatchMode="contains"
                          filterPlaceholder="jj/mm/aaaa">
                    <p:cellEditor>
                        <f:facet name="output">
                            <h:outputText value="#{P.dateFin}">
                                <f:convertDateTime timeZone="Europe/Brussels" type="date" pattern="dd/MM/yyyy"/>
                            </h:outputText>
                        </f:facet>
                        <f:facet name="input">
                            <p:calendar id="pfin"
                                        value="#{P.dateFin}"
                                        showOn="button"
                                        required="true"
                                        requiredMessage="#{I18N['formulaire.message.required.date']}">
                                <f:convertDateTime timeZone="Europe/Brussels" type="date" pattern="dd/MM/yyyy"/>
                            </p:calendar>
                            <p:message for="pfin" display="tooltip"/>
                        </f:facet>
                    </p:cellEditor>
                </p:column>

                <!-- Tools: show/hide + clear filters -->
                <p:column>
                    <f:facet name="header">
                        <h:panelGroup style="display:flex;gap:.5rem;align-items:center;justify-content:flex-end">
                            <p:commandButton type="button" icon="pi pi-filter"
                                             onclick="PF('tpTbl').jq.toggleClass('hide-filters');" />
                            <p:commandButton type="button" icon="pi pi-times"
                                             onclick="PF('tpTbl').clearFilters();" />
                        </h:panelGroup>
                    </f:facet>
                </p:column>

                <p:ajax event="rowEdit" listener="#{tarifBean.onPenaRowEdit}" update="growl tarifP"/>
                <p:ajax event="rowEditCancel" listener="#{tarifBean.onPenaRowCancel}"/>
            </p:dataTable>

            <br/>
            <p:outputLabel value="#{I18N['tarifpenalite.explication.retard']}" />
            <br/><br/>

            <h:panelGroup layout="block" styleClass="button-bar">
                <h:panelGroup styleClass="left-buttons">
                    <p:commandButton icon="pi pi-plus"
                                     value="#{I18N['application.button.ajouterretard']}"
                                     action="#{tarifBean.addNewPenaRow}"
                                     update="tarifP" immediate="true"/>
                    <p:commandButton icon="pi pi-minus"
                                     value="#{I18N['application.button.supprimeretard']}"
                                     action="#{tarifBean.delPenaRow}"
                                     update="tarifP" immediate="true"/>
                </h:panelGroup>

                <h:panelGroup styleClass="right-buttons">
                    <p:commandButton icon="pi pi-home" value="#{I18N['application.button.return']}"
                                     action="#{tarifBean.flushTarifs}" immediate="true"/>
                    <p:commandButton icon="pi pi-check-circle" value="#{I18N['application.button.sauvegarder']}"
                                     action="#{tarifBean.newTarif}" ajax="false" />
                </h:panelGroup>
            </h:panelGroup>
        </h:form>
    </ui:define>
</ui:composition>
</html>
